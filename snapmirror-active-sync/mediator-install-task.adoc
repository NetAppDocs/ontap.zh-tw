---
sidebar: sidebar 
permalink: snapmirror-active-sync/mediator-install-task.html 
keywords: SM-BC, SMBC, cluster, peering, ONTAP Mediator, initialize, snapmirror active sync 
summary: SnapMirror 主動式同步需要您安裝及初始化 ONTAP Mediator 、並確保適當的叢集對等關係。 
---
= 設定 ONTAP Mediator 和叢集以進行 SnapMirror 主動式同步
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
SnapMirror 主動同步利用對等叢集、確保在發生容錯移轉情況時、資料可用。ONTAP Mediator 是確保業務持續運作、監控每個叢集健全狀況的關鍵資源。若要設定 SnapMirror 主動式同步、您必須先安裝 ONTAP Mediator 、並確保主叢集和次叢集已正確設定。

安裝 ONTAP Mediator 並設定叢集之後、您必須 <<initialize-the-ontap-mediator>> 用於 SnapMirror 主動同步的 ONTAP 調解器。您必須這樣做 xref:protect-task.html[建立、初始化及對應 SnapMirror 主動式同步的一致性群組]。



== 資訊媒體ONTAP

ONTAP 調解器在 SnapMirror 主動同步關係中爲 ONTAP 叢集建立仲裁。當偵測到故障時、它會協調自動容錯移轉、判斷哪個叢集是主要叢集、並確保資料能從正確目的地送達或送達。

.必要條件ONTAP
* 此《程式集》包含自己的一組先決條件。ONTAP安裝中介器之前、您必須符合這些先決條件。
+
如需詳細資訊、請參閱 link:https://docs.netapp.com/us-en/ontap-metrocluster/install-ip/task_configuring_the_ontap_mediator_service_from_a_metrocluster_ip_configuration.html["準備安裝ONTAP 《不知道如何安裝》服務"^]。

* 根據預設ONTAP 、此功能可透過TCP連接埠31784提供服務。您應該確定連接埠31784已開啟、而且可以在ONTAP 各個叢集和中介器之間使用。




== 安裝 ONTAP Mediator 並確認叢集組態

請繼續執行下列每個步驟。對於每個步驟、您都應該確認已執行特定組態。請使用每個步驟之後隨附的連結、視需要取得更多資訊。

.步驟
. 在ONTAP 確保來源叢集和目的地叢集已正確設定之前、請先安裝「盡力協助」服務。
+
xref:../mediator/index.html[準備安裝或升級 ONTAP Mediator 服務]

. 確認叢集之間存在叢集對等關係。
+

NOTE: SnapMirror 主動同步對於叢集對等關係而言、需要預設的 IPspace 。不支援自訂 IPspace 。

+
xref:../task_dp_prepare_mirror.html[設定對等關係]

. 確認已在每個叢集上建立儲存VM。
+
xref:../smb-config/create-svms-data-access-task.html[建立SVM]

. 確認每個叢集上的儲存VM之間存在對等關係。
+
xref:../peering/create-intercluster-svm-peer-relationship-93-later-task.html[建立SVM對等關係]

. 確認LUN的磁碟區已存在。
+
xref:../smb-config/create-volume-task.html[建立Volume]

. 確認叢集中的每個節點都至少建立一個SAN LIF。
+
link:../san-admin/manage-lifs-all-san-protocols-concept.html["叢集SAN環境中的LIF考量"]

+
link:../networking/create_a_lif.html["建立LIF"]

. 確認已建立必要的 LUN 並對應至 igroup 、用於將 LUN 對應至應用程式主機上的啟動器。
+
xref:../san-admin/provision-storage.html[建立LUN並對應igroup]

. 重新掃描應用程式主機以探索任何新的LUN。




== 使用自我簽署憑證初始化 ONTAP Mediator 以進行 SnapMirror 主動同步

安裝 ONTAP Mediator 並確認叢集組態後、您必須初始化 ONTAP Mediator 以進行叢集監控。您可以使用系統管理員或 ONTAP CLI 來初始化 ONTAP Mediator 。

[role="tabbed-block"]
====
.系統管理員
--
使用系統管理員、您可以將 ONTAP Mediator 伺服器設定為自動容錯移轉。如果您尚未使用第三方驗證的SSL憑證和CA、也可以將自行簽署的SSL和CA更換為第三方驗證的SSL憑證和CA。


IMPORTANT: 從 ONTAP 9.8 到 9.14.1 、 SnapMirror 主動式同步稱為 SnapMirror Business Continuity （ SM-BC ）。

.步驟
. 瀏覽至* Protection > Overview > Mediator > Configure *。
. 選取 * 新增 * 、然後輸入下列 ONTAP Mediator 伺服器資訊：
+
** IPV4位址
** 使用者名稱
** 密碼
** 憑證


. 您可以使用兩種方式提供「憑證」輸入：
+
** * 選項（ a ） * ：選取 * Import * （匯入 * ）以瀏覽至 `.crt` 檔案並匯入。
** * 選項（ b ） * ：複製的內容 `.crt` 檔案並貼到 * 憑證 * 欄位中。
+
正確輸入所有詳細資料後、所提供的憑證會安裝在所有對等叢集上。

+
image:configure-mediator-system-manager.png["系統管理員中介新增"]

+
當憑證新增完成時、 ONTAP Mediator 會新增至 ONTAP 叢集。

+
下列影像示範 ONTAP Mediator 組態成功：

+
image:successful-mediator-installation.png["中介新增成功"]。





--
.CLI
--
您可以使用 ONTAP CLI 從主叢集或次叢集初始化 ONTAP Mediator 。當您發出時 `mediator add` 命令在一個叢集上、 ONTAP Mediator 會自動新增至另一個叢集。

如果沒有有效的憑證授權單位（ CA ）憑證、就無法在 ONTAP 中初始化 ONTAP Mediator 。因此、您必須將有效的憑證授權單位新增至對等叢集的憑證存放區。

.步驟
. 從 ONTAP Mediator Linux VM/ 主機軟體安裝位置尋找 ONTAP Mediator CA 憑證 `cd /opt/netapp/lib/ontap_mediator/ontap_mediator/server_config`。
. 將有效的憑證授權單位新增至對等叢集上的憑證存放區。
+
* 範例 *

+
[listing]
----
[root@ontap-mediator server_config]# cat ca.crt
-----BEGIN CERTIFICATE-----
MIIFxTCCA62gAwIBAgIJANhtjk6HFCiOMA0GCSqGSIb3DQEBCwUAMHgxFTATBgNV
BAoMDE5ldEFwcCwgSW5jLjELMAkGA1UEBhMCVVMxEzARBgNVBAgMCkNhbGlmb3Ju
…
p+jdg5bG61cxkuvbRm7ykFbih1b88/Sgu5XJg2KRhjdISF98I81N+Fo=
-----END CERTIFICATE-----
----
. 將 ONTAP Mediator CA 憑證新增至 ONTAP 叢集。出現提示時、請插入從 ONTAP Mediator 取得的 CA 憑證。在所有對等叢集上重複這些步驟：
+
`security certificate install -type server-ca -vserver <vserver_name>`

+
* 範例 *

+
[listing]
----
[root@ontap-mediator ~]# cd /opt/netapp/lib/ontap_mediator/ontap_mediator/server_config

[root@ontap-mediator server_config]# cat ca.crt
-----BEGIN CERTIFICATE-----
MIIFxTCCA62gAwIBAgIJANhtjk6HFCiOMA0GCSqGSIb3DQEBCwUAMHgxFTATBgNV
BAoMDE5ldEFwcCwgSW5jLjELMAkGA1UEBhMCVVMxEzARBgNVBAgMCkNhbGlmb3Ju
…
p+jdg5bG61cxkuvbRm7ykFbih1b88/Sgu5XJg2KRhjdISF98I81N+Fo=
-----END CERTIFICATE-----
----
+
[listing]
----
C1_test_cluster::*> security certificate install -type server-ca -vserver C1_test_cluster

Please enter Certificate: Press when done
-----BEGIN CERTIFICATE-----
MIIFxTCCA62gAwIBAgIJANhtjk6HFCiOMA0GCSqGSIb3DQEBCwUAMHgxFTATBgNV
BAoMDE5ldEFwcCwgSW5jLjELMAkGA1UEBhMCVVMxEzARBgNVBAgMCkNhbGlmb3Ju
…
p+jdg5bG61cxkuvbRm7ykFbih1b88/Sgu5XJg2KRhjdISF98I81N+Fo=
-----END CERTIFICATE-----

You should keep a copy of the CA-signed digital certificate for future reference.

The installed certificate's CA and serial number for reference:
CA: ONTAP Mediator CA
serial: D86D8E4E87142XXX

The certificate's generated name for reference: ONTAPMediatorCA

C1_test_cluster::*>
----
. 檢視使用產生的憑證名稱所安裝的自我簽署 CA 憑證：
+
`security certificate show -common-name <common_name>`

+
* 範例 *

+
[listing]
----
C1_test_cluster::*> security certificate show -common-name ONTAPMediatorCA
Vserver    Serial Number   Certificate Name                       Type
---------- --------------- -------------------------------------- ------------
C1_test_cluster
           6BFD17DXXXXX7A71BB1F44D0326D2DEEXXXXX
                           ONTAPMediatorCA                        server-ca
    Certificate Authority: ONTAP Mediator CA
          Expiration Date: Thu Feb 15 14:35:25 2029
----
. 在其中一個叢集上初始化 ONTAP Mediator 。ONTAP Mediator 會自動新增至其他叢集：
+
`snapmirror mediator add -mediator-address <ip_address> -peer-cluster <peer_cluster_name> -username user_name`

+
* 範例 *

+
[listing]
----
C1_test_cluster::*> snapmirror mediator add -mediator-address 1.2.3.4 -peer-cluster C2_test_cluster -username mediatoradmin
Notice: Enter the mediator password.

Enter the password: ******
Enter the password again: ******
----
. 檢查 ONTAP Mediator 組態的狀態：
+
`snapmirror mediator show`

+
....
Mediator Address Peer Cluster     Connection Status Quorum Status
---------------- ---------------- ----------------- -------------
1.2.3.4          C2_test_cluster   connected        true
....
+
`Quorum Status` 指出 SnapMirror 一致性群組關係是否與 ONTAP Mediator 同步；狀態為 `true` 表示同步成功。



--
====


== 使用協力廠商憑證重新初始化 ONTAP Mediator

您可能需要重新初始化 ONTAP Mediator 服務。有時可能需要重新初始化 ONTAP Mediator 服務、例如變更 ONTAP Mediator IP 位址、憑證過期等。

下列程序說明當自我簽署的憑證需要由協力廠商憑證取代時，針對特定案例重新初始化 ONTAP Mediator 。

.關於這項工作
您需要以協力廠商憑證取代 SM-BC 叢集的自我簽署憑證、從 ONTAP 移除 ONTAP Mediator 組態、然後新增 ONTAP Mediator 。

[role="tabbed-block"]
====
.系統管理員
--
有了系統管理員、您必須從 ONTAP 叢集移除以舊的自我簽署憑證設定的 ONTAP Mediator 、並使用新的協力廠商憑證重新設定 ONTAP 叢集。

.步驟
. 選取功能表選項圖示、然後選取 * 移除 * 來移除 ONTAP Mediator 。
+

NOTE: 此步驟不會從 ONTAP 叢集移除自我簽署的 server-ca 。NetApp 建議您先瀏覽 * 憑證 * 索引標籤、然後手動移除、再執行下列步驟以新增協力廠商憑證：

+
image:remove-mediator.png["系統管理員中介移除"]

. 使用正確的憑證再次新增 ONTAP Mediator 。


ONTAP Mediator 現在已設定新的協力廠商自我簽署憑證。

image:configure-mediator-system-manager.png["系統管理員中介新增"]

--
.CLI
--
您可以使用 ONTAP CLI 以協力廠商憑證取代自我簽署的憑證、從主要或次要叢集重新初始化 ONTAP Mediator 。

.步驟
. 移除自我簽署的 `ca.crt` 當您為所有叢集使用自我簽署的憑證時、會較早安裝。在以下範例中、有兩個叢集：
+
* 範例 *

+
[listing]
----
 C1_test_cluster::*> security certificate delete -vserver C1_test_cluster -common-name ONTAPMediatorCA
 2 entries were deleted.

 C2_test_cluster::*> security certificate delete -vserver C2_test_cluster -common-name ONTAPMediatorCA *
 2 entries were deleted.
----
. 使用從 SM-BC 叢集移除先前設定的 ONTAP Mediator `-force true`：
+
* 範例 *

+
[listing]
----
C1_test_cluster::*> snapmirror mediator show
Mediator Address Peer Cluster     Connection Status Quorum Status
---------------- ---------------- ----------------- -------------
1.2.3.4          C2_test_cluster   connected         true

C1_test_cluster::*> snapmirror mediator remove -mediator-address 1.2.3.4 -peer-cluster C2_test_cluster -force true

Warning: You are trying to remove the ONTAP Mediator configuration with force. If this configuration exists on the peer cluster, it could lead to failure of a SnapMirror failover operation. Check if this configuration
         exists on the peer cluster C2_test_cluster and remove it as well.
Do you want to continue? {y|n}: y

Info: [Job 136] 'mediator remove' job queued

C1_test_cluster::*> snapmirror mediator show
This table is currently empty.
----
. 請參閱中所述的步驟 link:../mediator/manage-task.html#Replace-self-signed-certificates-with-trusted-third-party-certificates["以信任的協力廠商憑證取代自我簽署的憑證"] 如何從次級 CA 取得憑證、稱為 `ca.crt`。
+

NOTE: 。 `ca.crt` 具有某些屬性、這些屬性是從需要傳送至檔案中定義的 PKI 授權單位的要求所衍生而來 `/opt/netapp/lib/ontap_mediator/ontap_mediator/server_config/openssl_ca.cnf`。

. 新增第三方 ONTAP Mediator CA 憑證 `ca.crt` 從 ONTAP Mediator Linux VM/ 主機軟體安裝位置：
+
* 範例 *

+
[listing]
----
[root@ontap-mediator ~]# cd /opt/netapp/lib/ontap_mediator/ontap_mediator/server_config
[root@ontap-mediator server_config]# cat ca.crt
-----BEGIN CERTIFICATE-----
MIIFxTCCA62gAwIBAgIJANhtjk6HFCiOMA0GCSqGSIb3DQEBCwUAMHgxFTATBgNV
BAoMDE5ldEFwcCwgSW5jLjELMAkGA1UEBhMCVVMxEzARBgNVBAgMCkNhbGlmb3Ju
…
p+jdg5bG61cxkuvbRm7ykFbih1b88/Sgu5XJg2KRhjdISF98I81N+Fo=
-----END CERTIFICATE-----
----
. 新增 `ca.crt` 檔案至對等叢集。對所有對等叢集重複此步驟：
+
* 範例 *

+
[listing]
----
C1_test_cluster::*> security certificate install -type server-ca -vserver C1_test_cluster

Please enter Certificate: Press when done
-----BEGIN CERTIFICATE-----
MIIFxTCCA62gAwIBAgIJANhtjk6HFCiOMA0GCSqGSIb3DQEBCwUAMHgxFTATBgNV
BAoMDE5ldEFwcCwgSW5jLjELMAkGA1UEBhMCVVMxEzARBgNVBAgMCkNhbGlmb3Ju
…
p+jdg5bG61cxkuvbRm7ykFbih1b88/Sgu5XJg2KRhjdISF98I81N+Fo=
-----END CERTIFICATE-----

You should keep a copy of the CA-signed digital certificate for future reference.

The installed certificate's CA and serial number for reference:
CA: ONTAP Mediator CA
serial: D86D8E4E87142XXX

The certificate's generated name for reference: ONTAPMediatorCA

C1_test_cluster::*>
----
. 從 SnapMirror 主動同步叢集移除先前設定的 ONTAP Mediator ：
+
* 範例 *

+
[listing]
----
C1_test_cluster::*> snapmirror mediator show
Mediator Address Peer Cluster     Connection Status Quorum Status
---------------- ---------------- ----------------- -------------
1.2.3.4          C2_test_cluster  connected         true

C1_test_cluster::*> snapmirror mediator remove -mediator-address 1.2.3.4 -peer-cluster C2_test_cluster

Info: [Job 86] 'mediator remove' job queued
C1_test_cluster::*> snapmirror mediator show
This table is currently empty.
----
. 再次新增 ONTAP Mediator ：
+
* 範例 *

+
[listing]
----
C1_test_cluster::*> snapmirror mediator add -mediator-address 1.2.3.4 -peer-cluster C2_test_cluster -username mediatoradmin

Notice: Enter the mediator password.

Enter the password:
Enter the password again:

Info: [Job: 87] 'mediator add' job queued

C1_test_cluster::*> snapmirror mediator show
Mediator Address Peer Cluster     Connection Status Quorum Status
---------------- ---------------- ----------------- -------------
1.2.3.4          C2_test_cluster  connected         true
----
+
`Quorum Status` 指出 SnapMirror 一致性群組關係是否與中介者同步；狀態為 `true` 表示同步成功。



--
====